# Документация по безопасности системы «AvtoShop»

## 1. Обзор

Безопасность является критически важным аспектом системы «AvtoShop». Для защиты данных и контроля доступа реализован многоуровневый подход, охватывающий аутентификацию, авторизацию, защиту от веб-уязвимостей и обеспечение целостности данных.

---

## 2. Аутентификация

Аутентификация — это процесс проверки личности пользователя. В системе он реализован для администраторов, которые получают доступ к панели управления.

-   **Процесс**: Администратор вводит `username` и `password` на странице входа (`/login`). Эти данные отправляются на эндпоинт бэкенда `/api/login`.
-   **Хранение паролей**: Пароли пользователей **никогда не хранятся в открытом виде**. При регистрации нового пользователя его пароль обрабатывается криптографической функцией `bcrypt.hash()` для получения безопасного хеша. Именно этот хеш (`password_hash`) сохраняется в таблице `users`. Этот процесс является односторонним, т.е. восстановить исходный пароль из хеша невозможно.
-   **Проверка пароля**: При попытке входа система сравнивает хеш введенного пароля (полученный с помощью `bcrypt.compare()`) с хешем, хранящимся в базе данных. Это позволяет надежно проверить подлинность пароля, не зная его.

---

## 3. Аутентификация на основе JWT (JSON Web Tokens)

В случае успешной аутентификации сервер генерирует **JWT**, который является основным механизмом для последующей авторизации.

-   **Структура токена**: Токен состоит из трех частей (заголовок, полезная нагрузка, подпись). Полезная нагрузка (payload) нашего токена содержит:
    ```json
    {
      "userId": 1, // Идентификатор пользователя из таблицы users
      "iat": 1678886400, // Время создания токена (timestamp)
      "exp": 1678890000  // Время истечения срока действия (timestamp, +1 час)
    }
    ```
-   **Секретный ключ (`JWT_SECRET`)**: Для создания подписи токена используется секретный ключ. В соответствии с лучшими практиками безопасности, **ключ загружается из переменных окружения (`process.env.JWT_SECRET`)** и не хранится в коде. В среде разработки для этого используется `.env` файл, который исключен из системы контроля версий Git. Это предотвращает утечку ключа в публичный репозиторий.

---

## 4. Авторизация

Авторизация — это процесс предоставления доступа к определенным ресурсам на основе прав пользователя.

-   **Защита маршрутов**: Все маршруты, требующие прав администратора, защищены middleware `authenticateToken`.
-   **Механизм проверки**: Перед выполнением логики защищенного маршрута, `authenticateToken` перехватывает запрос и выполняет проверку JWT из заголовка `Authorization: Bearer <token>`. Если токен валиден, запрос передается дальше. В противном случае сервер возвращает ошибку `401 Unauthorized` или `403 Forbidden`.

---

## 5. Защита от веб-уязвимостей

### Защита от XSS (Cross-Site Scripting)
-   **Механизм защиты**: React, используемый на фронтенде, по умолчанию экранирует все данные, вставляемые в JSX. Это обеспечивает базовую, но мощную защиту от XSS-атак, предотвращая выполнение вредоносного кода, введенного пользователем.

### Защита от SQL-инъекций
-   **Механизм защиты**: В системе используется **параметризация запросов** (prepared statements). Все SQL-запросы, выполняемые через библиотеку `pg`, передают пользовательские данные отдельно от самого SQL-выражения (`... WHERE username = $1`, `[username]`). Драйвер базы данных сам заботится о безопасном экранировании этих данных. Этот метод является отраслевым стандартом и обеспечивает **полную защиту от SQL-инъекций**.

---

## 6. Дополнительные меры безопасности и рекомендации

### Конфигурация CORS (Cross-Origin Resource Sharing)
-   **Текущая настройка**: `app.use(cors())` разрешает запросы с **любого** источника. Это удобно для разработки, но небезопасно для продакшена.
-   **Рекомендация для продакшена**: Следует явно указать домен, с которого разрешены запросы, чтобы предотвратить использование вашего API сторонними сайтами.
    ```javascript
    // Пример для продакшена
    const corsOptions = {
      origin: 'https://your-avto-shop-domain.com' // Заменить на реальный домен фронтенда
    };
    app.use(cors(corsOptions));
    ```

### Безопасность зависимостей
-   **Риск**: Сторонние пакеты (npm-модули) могут содержать уязвимости, которые могут поставить под угрозу все приложение.
-   **Рекомендация**: Необходимо регулярно проводить аудит зависимостей с помощью встроенной команды NPM.
    ```bash
    # Запустите эту команду в директории /backend
    npm audit
    ```
-   Команда `npm audit fix` может автоматически исправить большинство найденных проблем.

### Использование HTTPS
-   **Риск**: Без HTTPS весь трафик между клиентом и сервером, включая JWT-токены, передается в незашифрованном виде и может быть перехвачен (атака "человек посередине").
-   **Рекомендация**: В производственной среде приложение **ОБЯЗАТЕЛЬНО** должно быть развернуто на хостинге, который работает по протоколу **HTTPS**. Это обеспечит шифрование всего трафика и сделает перехват токенов и других данных невозможным.
