# Архитектура системы «AvtoShop»

## 1. Обзор

Веб-приложение «AvtoShop» построено по классической **клиент-серверной архитектуре**. Эта модель разделяет систему на два основных, независимых друг от друга компонента:

1.  **Клиент (Frontend)**: Пользовательский интерфейс, который работает в браузере пользователя.
2.  **Сервер (Backend)**: Удаленный сервер, который обрабатывает бизнес-логику, управляет данными и обеспечивает безопасность.

Такое разделение позволяет независимо разрабатывать, тестировать и развертывать каждую часть системы, а также обеспечивает гибкость и масштабируемость.

---

## 2. Клиент (Frontend)

Клиентская часть представляет собой **одностраничное приложение (Single Page Application, SPA)**, разработанное с использованием библиотеки **React**.

### Ключевые характеристики:

-   **Точка входа**: Файл `src/index.js` является точкой входа, который рендерит основной компонент приложения — `<App />`.
-   **Маршрутизация**: Навигация внутри приложения реализована с помощью библиотеки `react-router-dom`. В файле `src/App.js` определены все маршруты, которые связывают URL-адреса с соответствующими React-компонентами (например, главная страница, страница входа, админ-панель). Это позволяет пользователю перемещаться по сайту без полной перезагрузки страницы, что значительно улучшает пользовательский опыт.
-   **Компонентная структура**: Весь интерфейс разбит на независимые, переиспользуемые компоненты, расположенные в директории `src/components/`. Это упрощает разработку и поддержку кода.
-   **Управление состоянием**: Для приложения такого масштаба управление состоянием реализовано локально в компонентах с помощью хуков React (`useState`, `useEffect`). Глобальное состояние (например, токен аутентификации) хранится в `localStorage` браузера для сохранения сессии между перезагрузками страницы.
-   **Защита маршрутов**: Компонент `ProtectedRoute.jsx` выступает в роли "стража", который перед рендерингом защищенного компонента проверяет наличие токена аутентификации в `localStorage` и разрешает доступ только авторизованным пользователям.
-   **Взаимодействие с сервером**: Для обмена данными с бэкендом используется библиотека `axios`. Все запросы к API (например, для получения списка услуг или входа в систему) являются асинхронными HTTP-запросами.

---

## 3. Сервер (Backend)

Серверная часть построена на платформе **Node.js** с использованием легковесного веб-фреймворка **Express.js**.

### Ключевые характеристики:

-   **RESTful API**: Бэкенд предоставляет **RESTful API** для взаимодействия с клиентом. API включает в себя эндпоинты для всех CRUD-операций (создание, чтение, обновление, удаление) над основными сущностями системы: услугами (`/api/products`), клиентами (`/api/clients`) и отзывами (`/api/reviews`).
-   **Бизнес-логика**: Сервер инкапсулирует в себе всю бизнес-логику, включая аутентификацию пользователей, валидацию данных и взаимодействие с базой данных.
-   **Цепочка Middleware**: Express активно использует промежуточное ПО для обработки запросов. Для защищенного эндпоинта цепочка выглядит так:
    1.  `cors()`: Проверяет, разрешен ли запрос с данного домена.
    2.  `express.json()`: Если в запросе есть тело (body) в формате JSON, оно парсится и помещается в `req.body`.
    3.  `authenticateToken`: Проверяет наличие и валидность JWT в заголовках. Если токен невалиден, цепочка прерывается.
    4.  `validate...`: Набор правил валидации и санации для полей в `req.body`.
    5.  `handleValidationErrors`: Проверяет, были ли ошибки на предыдущем шаге. Если да - прерывает цепочку.
    6.  **Обработчик маршрута**: Основная логика эндпоинта, которая выполняется, только если все предыдущие шаги прошли успешно.

---

## 4. База данных (Database)

В качестве системы управления базами данных используется внешняя реляционная СУБД **PostgreSQL**, размещенная на облачной платформе **Supabase**.

-   **Взаимодействие**: Бэкенд подключается к базе данных с помощью библиотеки `pg` через строку подключения, указанную в `backend/db.js`.
-   **Защита от SQL-инъекций**: Все запросы к базе данных являются **параметризованными**. Это означает, что пользовательские данные передаются в SQL-запрос отдельно от самого текста запроса, что является стандартным и надежным способом предотвращения SQL-инъекций.

---

## 5. Диаграмма потока данных: "Вход администратора"

Этот сценарий наглядно демонстрирует взаимодействие всех частей системы.

1.  **Клиент (Браузер)**: Администратор на странице `/login` заполняет форму и нажимает "Войти".
2.  **Компонент `Login.jsx`**:
    -   Собирает данные из полей формы (`username`, `password`).
    -   Вызывает `axios.post('http://<адрес_сервера>/api/login', { username, password })`.
3.  **Сервер (Express)**:
    -   Получает `POST` запрос на эндпоинт `/api/login`.
    -   Обработчик эндпоинта выполняет `SELECT id, password_hash FROM users WHERE username = $1`.
4.  **База данных (PostgreSQL)**:
    -   Находит пользователя по `username` и возвращает его `id` и `password_hash` на сервер.
5.  **Сервер (Express)**:
    -   С помощью `bcrypt.compare()` сравнивает хеш из БД с хешем пароля, присланного пользователем.
    -   Если хеши совпадают, с помощью `jwt.sign()` создается токен доступа (JWT), содержащий `{ userId: id }` и срок жизни `1 час`.
    -   Отправляет ответ `200 OK` клиенту с телом `{"token": "..."}`.
6.  **Компонент `Login.jsx`**:
    -   Получает ответ от сервера.
    -   Сохраняет полученный токен в `localStorage.setItem('token', response.data.token)`.
    -   Используя `react-router-dom`, программно перенаправляет пользователя на защищенную страницу `/admin`.
7.  **Запрос к защищенному ресурсу**:
    -   При монтировании компонента `AdminPanel.jsx` он делает `GET` запрос на `/api/clients`.
    -   `axios` автоматически добавляет заголовок `Authorization: Bearer <токен_из_localStorage>`.
    -   Middleware `authenticateToken` на сервере проверяет токен и, убедившись в его валидности, разрешает доступ к данным о клиентах.
